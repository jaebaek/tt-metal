name: "Build tt-metal docker artifacts"

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-docker-image:
    env:
      TT_METAL_ENV: ${{ vars.TT_METAL_ENV }}
      CONFIG: ci
      SILENT: 0
      VERBOSE: 1
      TT_METAL_DOCKER_IMAGE: ubuntu-20.04-amd64
      TT_METAL_DOCKER_IMAGE_TAG: latest
    environment: dev
    runs-on: build
    steps:
      - uses: tenstorrent-metal/metal-workflows/.github/actions/checkout-with-submodule-lfs@v2.0.0
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: https://ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # - name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v3
      # - name: Build and push Docker image
      #   id: push
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: .
      #     file: ./dockerfile/ubuntu-20.04-amd64.Dockerfile
      #     push: true
      #     tags: ghcr.io/${{ github.repository }}/${{ env.TT_METAL_DOCKER_IMAGE }}:${{ github.ref_name == 'main' ? 'latest' : github.actor_id }}
      - name: Build Docker image
        run: |
          ./scripts/docker/build_docker_image.sh ${{ env.TT_METAL_DOCKER_IMAGE }}:${{ env.TT_METAL_DOCKER_IMAGE_TAG }}
      - name: Determine Docker Image Tag
        id: set-image
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${GITHUB_ACTOR}" >> $GITHUB_ENV
          fi
      - name: Push Docker image to GitHub Container Registry
        run: |
          docker tag ${{ env.TT_METAL_DOCKER_IMAGE }}:${{ env.TT_METAL_DOCKER_IMAGE_TAG }} ghcr.io/${{ github.repository }}/${{ env.TT_METAL_DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
          docker push ghcr.io/${{ github.repository }}/${{ env.TT_METAL_DOCKER_IMAGE }}:${{ env.IMAGE_TAG }}
      # - name: Save Docker image
      #   run: |
      #     docker save ${{ env.TT_METAL_DOCKER_IMAGE_TAG }} | gzip > /tmp/docker_image.tar.gz   
      # - name: Upload Docker image as artifact
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: docker_image.tar.gz
      #     path: /tmp/docker_image.tar.gz 